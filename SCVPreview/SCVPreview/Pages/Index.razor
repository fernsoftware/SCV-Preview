@page "/"

@using System.IO
@using SCVPreview.SCV

@inject NavigationManager _navigationManager 

<h1 class="ui header">
    Single-Customer-View Preview
    <div class="sub header">
        Upload a SCV file to review its contents
    </div>
</h1>

<p>
    Under the <a href="http://www.prarulebook.co.uk/rulebook/Content/Part/304147/">Depositor Protection Rules</a>, FSCS must pay compensation to customers within 15 business days of a deposit taker failing. We target ourselves to exceed this and pay within seven days, so that customers can get their money back as soon as possible.
</p>

<h3 class="ui header">
    Select a file
</h3>

<form class="ui form">
    <div class="field">
        <div class="ui input">
            <InputFile OnChange="@OnInputFileChange" />
        </div>
    </div>
</form>

@if (records.Any())
{
    <table class="ui celled striped table">
        <thead>
            <tr>
                <th class="collapsing">SCV ID</th>
                <th>Name</th>
                <th class="collapsing">Address</th>
                <th class="collapsing">Email</th>
                <th class="collapsing">Account</th>
                <th class="collapsing"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var record in records)
            {
                <tr>
                    <td>@record.Identifier</td>
                    <td class="single line">@record.NameFormatted()</td>
                    <td>@((MarkupString)(@record.AddressFormatted()))</td>
                    <td>
                        @if (!string.IsNullOrEmpty(record.Email))
                        {
                            <a href="mailto:@record.Email">@record.Email</a>
                        }
                    </td>
                    <td>@((MarkupString)(@record.AccountFormatted()))</td>
                    <td>
                        <button class="ui basic icon button" @onclick="@(e => RowClicked(e, record.Identifier))">
                            <i class="right arrow icon"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


@code
{
    public List<SCV> records = new List<SCV>();

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        int maxAllowedFiles = 1;
        int maxFileSize = 1024 * 1024 * 15;

        string line;

        foreach (var file in e.GetMultipleFiles(maxAllowedFiles))
        {
            using (var reader = new StreamReader(file.OpenReadStream(maxFileSize)))
            {
                while ((line = await reader.ReadLineAsync()) != null)
                {
                    var split = line.Split("|");

                    if (split.Length == 51)
                    {
                        records.Add(new SCV(line));
                    }
                }
            }
        }

        this.StateHasChanged();
    }

    private void RowClicked(MouseEventArgs e, string identifier)
    {
        var record = records.FirstOrDefault(x => x.Identifier == identifier);

        if (record != null)
        {
            _navigationManager.NavigateTo($"/details?id={record.Identifier}");
        }
    }
}